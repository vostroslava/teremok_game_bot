{% extends "admin/base_admin.html" %}

{% block content %}
<div class="mb-8" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>üë• –õ–∏–¥—ã</h1>
        <p style="color: var(--text-secondary);">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
    </div>

    <button class="btn btn-primary" onclick="exportLeads()">
        <i data-feather="download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Sheets
    </button>
</div>

<!-- Filters -->
<div class="glass-panel mb-8" style="padding: 24px;">
    <form method="get" class="grid-cols-4" style="align-items: end; gap: 16px;">
        <input type="hidden" name="key" value="{{ key or '' }}">
        <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
        <input type="hidden" name="sort_order" value="{{ current_sort_order }}">

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 0.875rem; color: var(--text-secondary);">–°—Ç–∞—Ç—É—Å</label>
            <select name="status"
                style="padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
                <option value="all" {% if current_status=='all' %}selected{% endif %}>–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="new" {% if current_status=='new' %}selected{% endif %}>–ù–æ–≤—ã–µ</option>
                <option value="in_progress" {% if current_status=='in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ</option>
                <option value="done" {% if current_status=='done' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ</option>
                <option value="spam" {% if current_status=='spam' %}selected{% endif %}>–°–ø–∞–º</option>
            </select>
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 0.875rem; color: var(--text-secondary);">–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</label>
            <input type="number" name="days" value="{{ current_days or '' }}" placeholder="–í—Å–µ –≤—Ä–µ–º—è"
                style="padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 0.875rem; color: var(--text-secondary);">–ü–æ–∏—Å–∫</label>
            <input type="text" name="search" value="{{ current_search or '' }}" placeholder="–ò–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω..."
                style="padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
        </div>

        <button type="submit" class="btn btn-primary" style="height: 42px;">–ù–∞–π—Ç–∏</button>
    </form>
</div>

<!-- Leads Table -->
<div class="glass-panel" style="padding: 0; overflow: hidden;">
    {% if leads %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>
                        <a href="?sort_by=created_at&sort_order={% if current_sort_by == 'created_at' and current_sort_order == 'desc' %}asc{% else %}desc{% endif %}&status={{ current_status }}&search={{ current_search }}&days={{ current_days }}"
                            style="display: flex; align-items: center; gap: 4px;">
                            –î–∞—Ç–∞
                            {% if current_sort_by == 'created_at' %}
                            {% if current_sort_order == 'desc' %}‚Üì{% else %}‚Üë{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>–ò–º—è / –†–æ–ª—å</th>
                    <th>–ö–æ–Ω—Ç–∞–∫—Ç—ã</th>
                    <th>–ö–æ–º–ø–∞–Ω–∏—è</th>
                    <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                    <th>
                        <a href="?sort_by=status&sort_order={% if current_sort_by == 'status' and current_sort_order == 'desc' %}asc{% else %}desc{% endif %}&status={{ current_status }}&search={{ current_search }}&days={{ current_days }}"
                            style="display: flex; align-items: center; gap: 4px;">
                            –°—Ç–∞—Ç—É—Å
                            {% if current_sort_by == 'status' %}
                            {% if current_sort_order == 'desc' %}‚Üì{% else %}‚Üë{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>–ó–∞–º–µ—Ç–∫–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for lead in leads %}
                <tr id="row-{{ lead.user_id }}">
                    <td style="white-space: nowrap; color: var(--text-secondary);">
                        {{ lead.created_at[:16] }}
                    </td>
                    <td>
                        <div style="font-weight: 600;">{{ lead.name }}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ lead.role }}</div>
                    </td>
                    <td>
                        <div style="margin-bottom: 4px;">{{ lead.phone }}</div>
                        {% if lead.telegram_username %}
                        <a href="https://t.me/{{ lead.telegram_username }}" target="_blank"
                            style="color: var(--text-accent); font-size: 0.8rem;">
                            @{{ lead.telegram_username }}
                        </a>
                        {% endif %}
                    </td>
                    <td>
                        <div>{{ lead.company or '-' }}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ lead.team_size }}</div>
                    </td>
                    <td>
                        <span class="badge" style="background: rgba(255,255,255,0.05);">{{ lead.product }}</span>
                    </td>
                    <td>
                        <select onchange="updateStatus({{ lead.user_id }}, this.value)"
                            style="padding: 4px; border-radius: 4px; background: transparent; color: white; border: 1px solid var(--border-color);">
                            <option value="new" {% if lead.status=='new' %}selected{% endif %}>–ù–æ–≤—ã–π</option>
                            <option value="in_progress" {% if lead.status=='in_progress' %}selected{% endif %}>–í —Ä–∞–±–æ—Ç–µ
                            </option>
                            <option value="done" {% if lead.status=='done' %}selected{% endif %}>–ó–∞–≤–µ—Ä—à–µ–Ω</option>
                            <option value="spam" {% if lead.status=='spam' %}selected{% endif %}>–°–ø–∞–º</option>
                        </select>
                    </td>
                    <td>
                        <textarea onblur="updateNotes({{ lead.user_id }}, this.value)" rows="1" placeholder="–ó–∞–º–µ—Ç–∫–∞..."
                            style="background: transparent; border: none; color: var(--text-secondary); resize: vertical; width: 100%;">{{ lead.notes or '' }}</textarea>
                    </td>
                    <td>
                        <button onclick="copyToClipboard('{{ lead.name }} {{ lead.phone }}')" class="btn"
                            style="padding: 4px; color: var(--text-secondary);" title="–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç">
                            <i data-feather="copy" style="width: 16px; height: 16px;"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty">–õ–∏–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    async function updateStatus(userId, status) {
        try {
            const response = await fetch(`/app/admin/api/lead/${userId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ status: status })
            });

            if (response.ok) {
                // Show toast or highlight row
                const batch = document.querySelector(`#row-${userId} .badge`);
                // simplistic feedback
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
        }
    }

    async function updateNotes(userId, notes) {
        try {
            await fetch(`/app/admin/api/lead/${userId}/status`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ notes: notes }) // Server should merge updates usually, check implementation
            });
        } catch (e) {
            console.error(e);
        }
    }

    async function exportLeads() {
        const btn = document.querySelector('button[onclick="exportLeads()"]');
        btn.disabled = true;
        btn.innerHTML = `<i data-feather="loader" class="spin"></i> –≠–∫—Å–ø–æ—Ä—Ç...`;
        feather.replace();

        try {
            // Get key from hidden input
            const key = document.querySelector('input[name="key"]').value;
            const url = '/app/admin/api/export/leads' + (key ? `?key=${key}` : '');

            const response = await fetch(url, { method: 'POST' });
            const data = await response.json();

            if (data.status === 'ok') {
                alert(`–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${data.count} –ª–∏–¥–æ–≤ –≤ Google Sheets!`);
            } else {
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + data.error);
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<i data-feather="download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Sheets`;
            feather.replace();
        }
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text);
    }
</script>
<style>
    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}