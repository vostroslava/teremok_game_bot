{% extends "admin/base_admin.html" %}

{% block content %}
<div class="mb-8" style="display: flex; justify-content: space-between; align-items: center;">
    <div>
        <h1>üß© –¢–µ—Å—Ç—ã</h1>
        <p style="color: var(--text-secondary);">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤</p>
    </div>

    <button class="btn btn-primary" onclick="exportTests()">
        <i data-feather="download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Sheets
    </button>
</div>

<!-- Filters -->
<div class="glass-panel mb-8" style="padding: 24px;">
    <form method="get" class="grid-cols-4" style="align-items: end; gap: 16px;">
        <input type="hidden" name="key" value="{{ key or '' }}">
        <input type="hidden" name="sort_by" value="{{ current_sort_by }}">
        <input type="hidden" name="sort_order" value="{{ current_sort_order }}">

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 0.875rem; color: var(--text-secondary);">–ü—Ä–æ–¥—É–∫—Ç</label>
            <select name="product"
                style="padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
                <option value="all" {% if current_product=='all' %}selected{% endif %}>–í—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã</option>
                <option value="teremok" {% if current_product=='teremok' %}selected{% endif %}>–¢–µ—Ä–µ–º–æ–∫</option>
                <option value="formula" {% if current_product=='formula' %}selected{% endif %}>–§–æ—Ä–º—É–ª–∞</option>
            </select>
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 0.875rem; color: var(--text-secondary);">–¢–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</label>
            <select name="result_type"
                style="padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
                <option value="all" {% if current_type=='all' %}selected{% endif %}>–í—Å–µ —Ç–∏–ø—ã</option>
                {% for t in all_types %}
                <option value="{{ t.id }}" {% if current_type==t.id %}selected{% endif %}>{{ t.emoji }} {{ t.name }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div style="display: flex; flex-direction: column; gap: 8px;">
            <label style="font-size: 0.875rem; color: var(--text-secondary);">–ü–µ—Ä–∏–æ–¥ (–¥–Ω–µ–π)</label>
            <input type="number" name="days" value="{{ current_days or '' }}" placeholder="–í—Å–µ –≤—Ä–µ–º—è"
                style="padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); color: white; border-radius: 8px;">
        </div>

        <button type="submit" class="btn btn-primary" style="height: 42px;">–ù–∞–π—Ç–∏</button>
    </form>
</div>

<!-- Tests Table -->
<div class="glass-panel" style="padding: 0; overflow: hidden;">
    {% if tests %}
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>
                        <a href="?sort_by=created_at&sort_order={% if current_sort_by == 'created_at' and current_sort_order == 'desc' %}asc{% else %}desc{% endif %}&product={{ current_product }}&result_type={{ current_type }}&days={{ current_days }}"
                            style="display: flex; align-items: center; gap: 4px;">
                            –î–∞—Ç–∞
                            {% if current_sort_by == 'created_at' %}
                            {% if current_sort_order == 'desc' %}‚Üì{% else %}‚Üë{% endif %}
                            {% endif %}
                        </a>
                    </th>
                    <th>–ò–º—è / –†–æ–ª—å</th>
                    <th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
                    <th>–ü—Ä–æ–¥—É–∫—Ç</th>
                    <th>
                        <a href="?sort_by=scores&sort_order={% if current_sort_by == 'scores' and current_sort_order == 'desc' %}asc{% else %}desc{% endif %}&product={{ current_product }}&result_type={{ current_type }}&days={{ current_days }}"
                            style="display: flex; align-items: center; gap: 4px;">
                            –ë–∞–ª–ª—ã
                            {% if current_sort_by == 'scores' %}
                            {% if current_sort_order == 'desc' %}‚Üì{% else %}‚Üë{% endif %}
                            {% endif %}
                        </a>
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for test in tests %}
                <tr>
                    <td style="white-space: nowrap; color: var(--text-secondary);">
                        {{ test.created_at[:16] }}
                    </td>
                    <td>
                        <div style="font-weight: 500;">{{ test.name or '–ê–Ω–æ–Ω–∏–º' }}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">{{ test.role or '' }}</div>
                    </td>
                    <td>
                        <span style="font-size: 1.25rem; margin-right: 8px;">{{ test.type_emoji }}</span>
                        <b>{{ test.type_name or test.result_type }}</b>
                    </td>
                    <td>
                        <span class="badge" style="background: rgba(255,255,255,0.05);">{{ test.product }}</span>
                    </td>
                    <td style="font-size: 0.8rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis;">
                        {{ test.scores_pretty or test.scores }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty">–¢–µ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    async function exportTests() {
        const btn = document.querySelector('button[onclick="exportTests()"]');
        btn.disabled = true;
        btn.innerHTML = `<i data-feather="loader" class="spin"></i> –≠–∫—Å–ø–æ—Ä—Ç...`;
        feather.replace();

        try {
            // Get key from hidden input
            const key = document.querySelector('input[name="key"]').value;
            const url = '/app/admin/api/export/tests' + (key ? `?key=${key}` : '');

            const response = await fetch(url, { method: 'POST' });
            const data = await response.json();

            if (data.status === 'ok') {
                alert(`–≠–∫—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω!`); // Backend doesn't return count for tests currently? Or verify.
            } else {
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + data.error);
            }
        } catch (e) {
            alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
        } finally {
            btn.disabled = false;
            btn.innerHTML = `<i data-feather="download"></i> –≠–∫—Å–ø–æ—Ä—Ç –≤ Google Sheets`;
            feather.replace();
        }
    }
</script>
<style>
    .spin {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }
</style>
{% endblock %}